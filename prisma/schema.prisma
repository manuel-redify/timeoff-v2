generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                    String      @id @default(uuid())
  name                  String
  country               String      @db.Char(2) // ISO 3166-1 alpha-2
  timezone              String      @default("Europe/London")
  dateFormat            String      @default("YYYY-MM-DD") @map("date_format")
  startOfNewYear        Int         @default(1) @map("start_of_new_year")
  shareAllAbsences      Boolean     @default(false) @map("share_all_absences")
  isTeamViewHidden      Boolean     @default(false) @map("is_team_view_hidden")
  ldapAuthEnabled       Boolean     @default(false) @map("ldap_auth_enabled")
  ldapAuthConfig        String?     @map("ldap_auth_config")
  carryOver             Int         @default(0) @map("carry_over")
  mode                  Int         @default(1)
  companyWideMessage    String?     @map("company_wide_message")
  integrationApiEnabled Boolean     @default(false) @map("integration_api_enabled")
  integrationApiToken   String      @unique @default(uuid()) @map("integration_api_token")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  deletedAt             DateTime?   @map("deleted_at")

  defaultRoleId         String?     @map("default_role_id")
  defaultRole           Role?       @relation("CompanyDefaultRole", fields: [defaultRoleId], references: [id], onDelete: SetNull)

  // Relationships
  users                 User[]
  departments           Department[]
  leaveTypes            LeaveType[]
  bankHolidays          BankHoliday[]
  roles                 Role[]
  areas                 Area[]
  teams                 Team[]
  projects              Project[]
  approvalRules         ApprovalRule[]
  watcherRules          WatcherRule[]
  emailAudits           EmailAudit[]
  comments              Comment[]
  auditLogs             Audit[]
  schedules             Schedule[]

  @@index([deletedAt])
  @@index([name])
  @@map("companies")
}

model User {
  id               String       @id @default(uuid())
  clerkId          String       @unique @map("clerk_id")
  email            String       @unique
  name             String
  lastname         String
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  departmentId     String?      @map("department_id")
  department       Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  startDate        DateTime     @default(now()) @map("start_date") @db.Date
  endDate          DateTime?    @map("end_date") @db.Date
  country          String?      @db.Char(2)
  contractType     String       @default("Employee") @map("contract_type")
  activated        Boolean      @default(true)
  isAdmin          Boolean      @default(false) @map("is_admin")
  isAutoApprove    Boolean      @default(false) @map("is_auto_approve")
  defaultRoleId    String?      @map("default_role_id")
  defaultRole      Role?        @relation("UserDefaultRole", fields: [defaultRoleId], references: [id], onDelete: SetNull)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  deletedAt        DateTime?    @map("deleted_at")

  // Relations
  managedDepartments Department[] @relation("DepartmentBoss")
  supervisedDepartments DepartmentSupervisor[]
  leaveRequests      LeaveRequest[] @relation("UserLeaves")
  approvedLeaves      LeaveRequest[] @relation("ApproverLeaves")
  allowanceAdjustments UserAllowanceAdjustment[]
  teams               Team[]        @relation("UserTeams")
  projects            UserProject[]
  roleAreas           UserRoleArea[]
  approvalSteps       ApprovalStep[]
  auditLogs           Audit[]
  comments            Comment[]
  feeds               UserFeed[]
  emailAudits         EmailAudit[]
  schedules           Schedule[]

  @@index([clerkId])
  @@index([companyId])
  @@index([departmentId])
  @@index([email])
  @@index([lastname])
  @@index([deletedAt])
  @@map("users")
}

model Department {
  id                    String      @id @default(uuid())
  name                  String
  allowance             Decimal     @default(9999) @db.Decimal(10, 2) // 9999 = use company default
  includePublicHolidays Boolean     @default(true) @map("include_public_holidays")
  isAccruedAllowance    Boolean     @default(false) @map("is_accrued_allowance")
  bossId                String?     @map("boss_id") // Primary Supervisor (Head of Department)
  boss                  User?       @relation("DepartmentBoss", fields: [bossId], references: [id], onDelete: SetNull)
  companyId             String      @map("company_id")
  company               Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  deletedAt             DateTime?   @map("deleted_at")

  // Relationships
  supervisors           DepartmentSupervisor[]
  users                 User[]
  
  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([bossId])
  @@index([deletedAt])
  @@map("departments")
}

model LeaveType {
  id               String       @id @default(uuid())
  name             String
  color            String       @default("#ffffff")
  useAllowance     Boolean      @default(true) @map("use_allowance")
  limit            Int?
  sortOrder        Int          @default(0) @map("sort_order")
  autoApprove      Boolean      @default(false) @map("auto_approve")
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  deletedAt        DateTime?    @map("deleted_at")

  // Relationships
  leaveRequests    LeaveRequest[]

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@map("leave_types")
}

model Role {
  id               String       @id @default(uuid())
  name             String
  priorityWeight   Int          @default(0) @map("priority_weight")
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relationships
  companiesDefault Company[]    @relation("CompanyDefaultRole")
  usersDefault     User[]       @relation("UserDefaultRole")
  userProjects     UserProject[]
  userRoleAreas    UserRoleArea[]
  approvalRulesSub ApprovalRule[] @relation("SubjectRole")
  approvalRulesApp ApprovalRule[] @relation("ApproverRole")
  approvalSteps    ApprovalStep[]
  watcherRules     WatcherRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("roles")
}

model Area {
  id               String       @id @default(uuid())
  name             String
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relationships
  userRoleAreas    UserRoleArea[]
  approvalRules    ApprovalRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("areas")
}

model Team {
  id               String       @id @default(uuid())
  name             String
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relationships
  users            User[]       @relation("UserTeams")
  watcherRules     WatcherRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("teams")
}

model Project {
  id               String       @id @default(uuid())
  name             String
  type             String       // 'Project', 'Client', 'Internal', etc.
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relationships
  userProjects     UserProject[]
  approvalSteps    ApprovalStep[]
  watcherRules     WatcherRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("projects")
}

model UserProject {
  id               String       @id @default(uuid())
  userId           String       @map("user_id")
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId        String       @map("project_id")
  project          Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roleId           String?      @map("role_id")
  role             Role?        @relation(fields: [roleId], references: [id], onDelete: SetNull)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@unique([userId, projectId, roleId])
  @@index([userId])
  @@index([projectId])
  @@map("user_project")
}

model UserRoleArea {
  id               String       @id @default(uuid())
  userId           String       @map("user_id")
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId           String       @map("role_id")
  role             Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  areaId           String?      @map("area_id")
  area             Area?        @relation(fields: [areaId], references: [id], onDelete: SetNull)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@unique([userId, roleId, areaId])
  @@index([userId])
  @@index([roleId])
  @@index([areaId])
  @@map("user_role_area")
}

model DepartmentSupervisor {
  departmentId String     @map("department_id")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  userId       String     @map("user_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  @@id([departmentId, userId])
  @@map("department_supervisor")
}

enum LeaveStatus {
  NEW             @map("new")
  APPROVED        @map("approved")
  REJECTED        @map("rejected")
  PENDING_REVOKE  @map("pending_revoke")
  CANCELED        @map("canceled")
}

enum DayPart {
  ALL        @map("all")
  MORNING    @map("morning")
  AFTERNOON  @map("afternoon")
}

model LeaveRequest {
  id               String       @id @default(uuid())
  dateStart        DateTime     @map("date_start") @db.Date
  dayPartStart     DayPart      @default(ALL) @map("day_part_start")
  dateEnd          DateTime     @map("date_end") @db.Date
  dayPartEnd       DayPart      @default(ALL) @map("day_part_end")
  status           LeaveStatus  @default(NEW)
  userId           String       @map("user_id")
  user             User         @relation("UserLeaves", fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId      String       @map("leave_type_id")
  leaveType        LeaveType    @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)
  approverId       String?      @map("approver_id")
  approver         User?        @relation("ApproverLeaves", fields: [approverId], references: [id], onDelete: SetNull)
  employeeComment  String?      @map("employee_comment") @db.Text
  approverComment  String?      @map("approver_comment") @db.Text
  decidedAt        DateTime?    @map("decided_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  deletedAt        DateTime?    @map("deleted_at")

  // Relationships
  approvalSteps    ApprovalStep[]

  @@index([userId])
  @@index([status])
  @@index([dateStart, dateEnd])
  @@index([deletedAt])
  @@map("leave_requests")
}

model UserAllowanceAdjustment {
  id                    String      @id @default(uuid())
  year                  Int
  adjustment            Decimal     @default(0) @db.Decimal(10, 2)
  carriedOverAllowance  Decimal     @default(0) @map("carried_over_allowance") @db.Decimal(10, 2)
  userId                String      @map("user_id")
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now()) @map("created_at")

  @@unique([userId, year])
  @@index([userId])
  @@map("user_allowance_adjustments")
}

model BankHoliday {
  id               String       @id @default(uuid())
  name             String
  date             DateTime     @db.Date
  country          String       @default("UK") @db.Char(2)
  companyId        String       @map("company_id")
  company          Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  deletedAt        DateTime?    @map("deleted_at")

  @@unique([companyId, date, deletedAt])
  @@index([companyId])
  @@index([date])
  @@map("bank_holidays")
}

model Schedule {
  id               String       @id @default(uuid())
  monday           Int          @default(1) // 1=working, 2=not working, 3=morning, 4=afternoon
  tuesday          Int          @default(1)
  wednesday        Int          @default(1)
  thursday         Int          @default(1)
  friday           Int          @default(1)
  saturday         Int          @default(2)
  sunday           Int          @default(2)
  companyId        String?      @map("company_id")
  company          Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId           String?      @map("user_id")
  user             User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@map("schedules")
}

model ApprovalRule {
  id                    String      @id @default(uuid())
  requestType           String      @map("request_type") // 'LEAVE', etc.
  projectType           String      @map("project_type") // 'Project', 'Client', 'Internal', etc.
  subjectRoleId         String      @map("subject_role_id")
  subjectRole           Role        @relation("SubjectRole", fields: [subjectRoleId], references: [id], onDelete: Cascade)
  subjectAreaId         String?     @map("subject_area_id")
  subjectArea           Area?       @relation(fields: [subjectAreaId], references: [id], onDelete: SetNull)
  approverRoleId        String      @map("approver_role_id")
  approverRole          Role        @relation("ApproverRole", fields: [approverRoleId], references: [id], onDelete: Cascade)
  approverAreaConstraint String?    @map("approver_area_constraint") // 'SAME_AS_SUBJECT', 'ANY', etc.
  teamScopeRequired     Boolean     @default(false) @map("team_scope_required")
  sequenceOrder         Int?        @map("sequence_order")
  companyId             String      @map("company_id")
  company               Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([subjectRoleId])
  @@index([approverRoleId])
  @@map("approval_rules")
}

model ApprovalStep {
  id                    String      @id @default(uuid())
  leaveId               String      @map("leave_id")
  leaveRequest          LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)
  approverId            String      @map("approver_id")
  approver              User        @relation(fields: [approverId], references: [id], onDelete: Cascade)
  roleId                String?      @map("role_id")
  role                  Role?        @relation(fields: [roleId], references: [id], onDelete: SetNull)
  status                Int         // 1=pending, 2=approved, 3=rejected
  sequenceOrder         Int?        @map("sequence_order")
  projectId             String?     @map("project_id")
  project               Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  @@index([leaveId])
  @@index([approverId])
  @@map("approval_steps")
}

model WatcherRule {
  id                    String      @id @default(uuid())
  requestType           String      @map("request_type")
  projectType           String?     @map("project_type")
  roleId                String?     @map("role_id")
  role                  Role?       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  teamId                String?     @map("team_id")
  team                  Team?       @relation(fields: [teamId], references: [id], onDelete: SetNull)
  projectId             String?     @map("project_id")
  project               Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  teamScopeRequired      Boolean     @default(false) @map("team_scope_required")
  contractType          String?     @map("contract_type")
  companyId             String      @map("company_id")
  company               Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([roleId])
  @@map("watcher_rules")
}

model EmailAudit {
  id               String       @id @default(uuid())
  email            String
  subject          String
  body             String       @db.Text
  companyId        String?      @map("company_id")
  company          Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId           String?      @map("user_id")
  user             User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt        DateTime     @default(now()) @map("created_at")

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
  @@map("email_audit")
}

model UserFeed {
  id               String       @id @default(uuid())
  name             String
  feedToken        String       @unique @map("feed_token")
  type             String       // 'calendar', 'teamview', etc.
  userId           String       @map("user_id")
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@index([userId])
  @@index([feedToken])
  @@map("user_feeds")
}

model Comment {
  id               String       @id @default(uuid())
  entityType       String       @map("entity_type")
  entityId         String       @map("entity_id")
  comment          String       @db.Text
  companyId        String?      @map("company_id")
  company          Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  byUserId         String?      @map("by_user_id")
  byUser           User?        @relation(fields: [byUserId], references: [id], onDelete: SetNull)
  at               DateTime     @default(now())

  @@index([entityType, entityId])
  @@index([companyId])
  @@map("comments")
}

model Audit {
  id               String       @id @default(uuid())
  entityType       String       @map("entity_type")
  entityId         String       @map("entity_id")
  attribute        String
  oldValue         String?      @map("old_value") @db.Text
  newValue         String?      @map("new_value") @db.Text
  companyId        String?      @map("company_id")
  company          Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  byUserId         String?      @map("by_user_id")
  byUser           User?        @relation(fields: [byUserId], references: [id], onDelete: SetNull)
  at               DateTime     @default(now())

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([at])
  @@map("audit")
}
