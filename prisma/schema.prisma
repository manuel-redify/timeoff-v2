generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                     String         @id @default(uuid())
  name                   String
  country                String         @db.Char(2)
  timezone               String         @default("Europe/London")
  dateFormat             String         @default("YYYY-MM-DD") @map("date_format")
  startOfNewYear         Int            @default(1) @map("start_of_new_year")
  shareAllAbsences       Boolean        @default(false) @map("share_all_absences")
  isTeamViewHidden       Boolean        @default(false) @map("is_team_view_hidden")
  ldapAuthEnabled        Boolean        @default(false) @map("ldap_auth_enabled")
  ldapAuthConfig         String?        @map("ldap_auth_config")
  carryOver              Int            @default(0) @map("carry_over")
  mode                   Int            @default(1)
  companyWideMessage     String?        @map("company_wide_message")
  integrationApiEnabled  Boolean        @default(false) @map("integration_api_enabled")
  integrationApiToken    String         @unique @default(uuid()) @map("integration_api_token")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  deletedAt              DateTime?      @map("deleted_at")
  defaultRoleId          String?        @map("default_role_id")
  allowNegativeAllowance Boolean        @default(false) @map("allow_negative_allowance")
  defaultAllowance       Decimal        @default(20) @map("default_allowance") @db.Decimal(10, 2)
  approvalRules          ApprovalRule[]
  areas                  Area[]
  auditLogs              Audit[]
  bankHolidays           BankHoliday[]
  clients                Client[]
  comments               Comment[]
  defaultRole            Role?          @relation("CompanyDefaultRole", fields: [defaultRoleId], references: [id])
  departments            Department[]
  emailAudits            EmailAudit[]
  leaveTypes             LeaveType[]
  projects               Project[]
  roles                  Role[]
  schedules              Schedule[]
  teams                  Team[]
  users                  User[]
  watcherRules           WatcherRule[]

  @@index([deletedAt])
  @@index([name])
  @@map("companies")
}

model User {
  id                      String                    @id @default(uuid())
  email                   String                    @unique
  name                    String
  lastname                String
  companyId               String                    @map("company_id")
  departmentId            String?                   @map("department_id")
  startDate               DateTime                  @default(now()) @map("start_date") @db.Date
  endDate                 DateTime?                 @map("end_date") @db.Date
  country                 String?                   @db.Char(2)
  contractTypeId          String?                   @map("contract_type_id")
  contractType           ContractType?             @relation("ContractTypeUsers", fields: [contractTypeId], references: [id])
  activated               Boolean                   @default(true)
  isAdmin                 Boolean                   @default(false) @map("is_admin")
  isAutoApprove           Boolean                   @default(false) @map("is_auto_approve")
  defaultRoleId           String?                   @map("default_role_id")
  createdAt               DateTime                  @default(now()) @map("created_at")
  updatedAt               DateTime                  @updatedAt @map("updated_at")
  deletedAt               DateTime?                 @map("deleted_at")
  icalFeedToken           String                    @unique @default(uuid()) @map("ical_feed_token")
  emailVerified           DateTime?                 @map("email_verified")
  image                   String?
  password                String?
  areaId                  String?                   @map("area_id")
  accounts                Account[]
  delegateDelegations     ApprovalDelegation[]      @relation("DelegateDelegations")
  supervisorDelegations   ApprovalDelegation[]      @relation("SupervisorDelegations")
  approvalSteps           ApprovalStep[]
  auditLogs               Audit[]
  comments                Comment[]
  supervisedDepartments   DepartmentSupervisor[]
  managedDepartments      Department[]              @relation("DepartmentBoss")
  emailAudits             EmailAudit[]
  approvedLeaves          LeaveRequest[]            @relation("ApproverLeaves")
  leaveRequests           LeaveRequest[]            @relation("UserLeaves")
  notificationPreferences NotificationPreference[]
  notifications           Notification[]
  schedules               Schedule[]
  sessions                Session[]
  allowanceAdjustments    UserAllowanceAdjustment[]
  feeds                   UserFeed[]
  projects                UserProject[]
  company                 Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  defaultRole             Role?                     @relation("UserDefaultRole", fields: [defaultRoleId], references: [id])
  area                    Area?                     @relation(fields: [areaId], references: [id])
  department              Department?               @relation(fields: [departmentId], references: [id])
  teams                   Team[]                    @relation("UserTeams")

  @@index([companyId])
  @@index([departmentId])
  @@index([areaId])
  @@index([email])
  @@index([lastname])
  @@index([deletedAt])
  @@map("users")
}

model Department {
  id                    String                 @id @default(uuid())
  name                  String
  allowance             Decimal?               @db.Decimal(10, 2)
  includePublicHolidays Boolean                @default(true) @map("include_public_holidays")
  isAccruedAllowance    Boolean                @default(false) @map("is_accrued_allowance")
  bossId                String?                @map("boss_id")
  companyId             String                 @map("company_id")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  deletedAt             DateTime?              @map("deleted_at")
  supervisors           DepartmentSupervisor[]
  boss                  User?                  @relation("DepartmentBoss", fields: [bossId], references: [id])
  company               Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users                 User[]

  @@unique([companyId, name, deletedAt])
  @@index([companyId])
  @@index([bossId])
  @@index([deletedAt])
  @@map("departments")
}

model LeaveType {
  id            String         @id @default(uuid())
  name          String
  color         String
  useAllowance  Boolean        @default(true) @map("use_allowance")
  sortOrder     Int            @default(0) @map("sort_order")
  autoApprove   Boolean        @default(false) @map("auto_approve")
  companyId     String         @map("company_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  limit         Int?           @map("annual_limit")
  leaveRequests LeaveRequest[]
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([name])
  @@map("leave_types")
}

model ContractType {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  color       String         @default("#95a5a6")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  users       User[]         @relation("ContractTypeUsers")
  watcherRules WatcherRule[] @relation("ContractTypeWatcherRules")

  @@index([name])
  @@map("contract_types")
}

model Role {
  id               String         @id @default(uuid())
  name             String
  priorityWeight   Int            @default(0) @map("priority_weight")
  companyId        String         @map("company_id")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  approvalRulesApp ApprovalRule[] @relation("ApproverRole")
  approvalRulesSub ApprovalRule[] @relation("SubjectRole")
  approvalSteps    ApprovalStep[]
  companiesDefault Company[]      @relation("CompanyDefaultRole")
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userProjects     UserProject[]
  usersDefault     User[]         @relation("UserDefaultRole")
  watcherRules     WatcherRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("roles")
}

model Area {
  id            String         @id @default(uuid())
  name          String
  companyId     String         @map("company_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  approvalRules ApprovalRule[]
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users         User[]

  @@unique([companyId, name])
  @@index([companyId])
  @@map("areas")
}

model Team {
  id           String        @id @default(uuid())
  name         String
  companyId    String        @map("company_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  watcherRules WatcherRule[]
  users        User[]        @relation("UserTeams")

  @@unique([companyId, name])
  @@index([companyId])
  @@map("teams")
}

model Client {
  id        String   @id @default(uuid())
  name      String
  companyId String   @map("company_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects  Project[] @relation("ClientProjects")

  @@unique([companyId, name])
  @@index([companyId])
  @@map("clients")
}

model Project {
  id          String         @id @default(uuid())
  name        String
  type        String
  description String?
  client      String?
  status      ProjectStatus  @default(ACTIVE)
  archived    Boolean        @default(false)
  isBillable  Boolean        @default(true) @map("is_billable")
  color       String?
  companyId   String         @map("company_id")
  clientId    String?        @map("client_id")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  approvalSteps ApprovalStep[]
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clientObj   Client?        @relation("ClientProjects", fields: [clientId], references: [id])
  userProjects  UserProject[]
  watcherRules  WatcherRule[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([status])
  @@index([archived])
  @@index([clientId])
  @@map("projects")
}

model UserProject {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  projectId String   @map("project_id")
  roleId    String?  @map("role_id")
  allocation Decimal  @default(100) @db.Decimal(5, 2)
  startDate DateTime @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  role      Role?    @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId, roleId])
  @@index([userId])
  @@index([projectId])
  @@map("user_project")
}

model DepartmentSupervisor {
  departmentId String     @map("department_id")
  userId       String     @map("user_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([departmentId, userId])
  @@map("department_supervisor")
}

model LeaveRequest {
  id              String         @id @default(uuid())
  dateStart       DateTime       @map("date_start") @db.Date
  dayPartStart    DayPart        @default(ALL) @map("day_part_start")
  dateEnd         DateTime       @map("date_end") @db.Date
  dayPartEnd      DayPart        @default(ALL) @map("day_part_end")
  status          LeaveStatus    @default(NEW)
  userId          String         @map("user_id")
  leaveTypeId     String         @map("leave_type_id")
  approverId      String?        @map("approver_id")
  employeeComment String?        @map("employee_comment")
  approverComment String?        @map("approver_comment")
  decidedAt       DateTime?      @map("decided_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")
  approvalSteps   ApprovalStep[]
  approver        User?          @relation("ApproverLeaves", fields: [approverId], references: [id])
  leaveType       LeaveType      @relation(fields: [leaveTypeId], references: [id])
  user            User           @relation("UserLeaves", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([dateStart, dateEnd])
  @@index([deletedAt])
  @@map("leave_requests")
}

model UserAllowanceAdjustment {
  id                   String   @id @default(uuid())
  year                 Int
  adjustment           Decimal  @default(0) @db.Decimal(10, 2)
  carriedOverAllowance Decimal  @default(0) @map("carried_over_allowance") @db.Decimal(10, 2)
  userId               String   @map("user_id")
  createdAt            DateTime @default(now()) @map("created_at")
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([userId])
  @@map("user_allowance_adjustments")
}

model BankHoliday {
  id        String    @id @default(uuid())
  name      String
  date      DateTime  @db.Date
  country   String    @db.Char(2)
  companyId String    @map("company_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, country, date, deletedAt])
  @@index([companyId])
  @@index([country])
  @@index([date])
  @@map("bank_holidays")
}

model Schedule {
  id        String   @id @default(uuid())
  monday    Int      @default(1)
  tuesday   Int      @default(1)
  wednesday Int      @default(1)
  thursday  Int      @default(1)
  friday    Int      @default(1)
  saturday  Int      @default(2)
  sunday    Int      @default(2)
  companyId String?  @map("company_id")
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("schedules")
}

model ApprovalRule {
  id                     String   @id @default(uuid())
  requestType            String   @map("request_type")
  projectType            String   @map("project_type")
  subjectRoleId          String   @map("subject_role_id")
  subjectAreaId          String?  @map("subject_area_id")
  approverRoleId         String   @map("approver_role_id")
  approverAreaConstraint String?  @map("approver_area_constraint")
  teamScopeRequired      Boolean  @default(false) @map("team_scope_required")
  sequenceOrder          Int?     @map("sequence_order")
  companyId              String   @map("company_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  approverRole           Role     @relation("ApproverRole", fields: [approverRoleId], references: [id], onDelete: Cascade)
  company                Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subjectArea            Area?    @relation(fields: [subjectAreaId], references: [id])
  subjectRole            Role     @relation("SubjectRole", fields: [subjectRoleId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([subjectRoleId])
  @@index([approverRoleId])
  @@map("approval_rules")
}

model ApprovalStep {
  id            String       @id @default(uuid())
  leaveId       String       @map("leave_id")
  approverId    String       @map("approver_id")
  roleId        String?      @map("role_id")
  status        Int
  sequenceOrder Int?         @map("sequence_order")
  projectId     String?      @map("project_id")
  policyId      String?      @map("policy_id")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  approver      User         @relation(fields: [approverId], references: [id], onDelete: Cascade)
  leaveRequest  LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)
  project       Project?     @relation(fields: [projectId], references: [id])
  role          Role?        @relation(fields: [roleId], references: [id])

  @@index([leaveId])
  @@index([approverId])
  @@map("approval_steps")
}

model WatcherRule {
  id                String   @id @default(uuid())
  requestType       String   @map("request_type")
  projectType       String?  @map("project_type")
  roleId            String?  @map("role_id")
  teamId            String?  @map("team_id")
  projectId         String?  @map("project_id")
  teamScopeRequired Boolean  @default(false) @map("team_scope_required")
  contractTypeId    String?   @map("contract_type_id")
  companyId         String   @map("company_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contractType      ContractType? @relation("ContractTypeWatcherRules", fields: [contractTypeId], references: [id])
  project           Project? @relation(fields: [projectId], references: [id])
  role              Role?    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  team              Team?    @relation(fields: [teamId], references: [id])

  @@index([companyId])
  @@index([roleId])
  @@index([contractTypeId])
  @@map("watcher_rules")
}

model ApprovalDelegation {
  id           String   @id @default(uuid())
  supervisorId String   @map("supervisor_id")
  delegateId   String   @map("delegate_id")
  startDate    DateTime @map("start_date") @db.Date
  endDate      DateTime @map("end_date") @db.Date
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  delegate     User     @relation("DelegateDelegations", fields: [delegateId], references: [id], onDelete: Cascade)
  supervisor   User     @relation("SupervisorDelegations", fields: [supervisorId], references: [id], onDelete: Cascade)

  @@index([supervisorId])
  @@index([delegateId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("approval_delegations")
}

model EmailAudit {
  id        String   @id @default(uuid())
  email     String
  subject   String
  body      String
  companyId String?  @map("company_id")
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
  @@map("email_audit")
}

model UserFeed {
  id        String   @id @default(uuid())
  name      String
  feedToken String   @unique @map("feed_token")
  type      String
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([feedToken])
  @@map("user_feeds")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Comment {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  comment    String
  companyId  String?  @map("company_id")
  byUserId   String?  @map("by_user_id")
  at         DateTime @default(now())
  byUser     User?    @relation(fields: [byUserId], references: [id])
  company    Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([companyId])
  @@map("comments")
}

model Audit {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  attribute  String
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  companyId  String?  @map("company_id")
  byUserId   String?  @map("by_user_id")
  at         DateTime @default(now())
  byUser     User?    @relation(fields: [byUserId], references: [id])
  company    Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([at])
  @@map("audit")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

model NotificationPreference {
  id      String @id @default(uuid())
  userId  String @map("user_id")
  type    String
  channel String @default("BOTH")
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("notification_preferences")
}

enum LeaveStatus {
  NEW            @map("new")
  APPROVED       @map("approved")
  REJECTED       @map("rejected")
  PENDING_REVOKE @map("pending_revoke")
  CANCELED       @map("canceled")
}

enum DayPart {
  ALL       @map("all")
  MORNING   @map("morning")
  AFTERNOON @map("afternoon")
}

enum ProjectStatus {
  ACTIVE    @map("active")
  INACTIVE  @map("inactive")
  COMPLETED @map("completed")
}
